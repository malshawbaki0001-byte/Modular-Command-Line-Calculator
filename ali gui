import sys
import random 
from PyQt6.QtWidgets import (
    QApplication, QWidget, QHBoxLayout, QVBoxLayout, 
    QPushButton, QListWidget, QListWidgetItem, QLabel, QFrame,
    QMessageBox, QDialog, QLineEdit, QFormLayout,
    QTableWidget, QTableWidgetItem, QHeaderView,
    QComboBox, QTabWidget, # <-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    QGraphicsDropShadowEffect,
    QStatusBar,
    QRadioButton, QButtonGroup
)
from PyQt6.QtCore import Qt, pyqtSlot
from PyQt6.QtGui import QFont, QColor

# --- (Ø§Ù„Ø£Ù†Ù…Ø§Ø· - Styles) ---

LIGHT_MODE_QSS = """
QDialog, QWidget { background-color: #f0f2f5; font-family: "Arial", sans-serif; color: #333; }
QFrame[class="card"], QWidget[class="card"] { background-color: #ffffff; border-radius: 10px; }
QLabel { font-size: 14px; font-weight: bold; color: #333; }
QLabel#TitleLabel { font-size: 24px; font-weight: bold; color: #003366; }
QLineEdit, QComboBox {
    font-size: 14px; padding: 10px 15px; border: 1px solid #d0d0d0;
    border-radius: 5px; background-color: #fafafa; color: black;
}
QLineEdit:focus, QComboBox:focus { border: 1px solid #007bff; }
QPushButton {
    font-size: 14px; font-weight: bold; color: white;
    padding: 12px; border-radius: 5px; border: none; margin-top: 5px;
    background-color: #007bff; 
}
QPushButton:hover { background-color: #0056b3; }
QPushButton[class="secondary"] { background-color: #6c757d; }
QPushButton[class="secondary"]:hover { background-color: #5a6268; }
QPushButton[class="danger"] { background-color: #dc3545; }
QPushButton[class="danger"]:hover { background-color: #c82333; }
QPushButton[class="success"] { background-color: #28a745; }
QPushButton[class="success"]:hover { background-color: #218838; }
QTableWidget {
    background-color: #ffffff; border: 1px solid #d0d0d0;
    border-radius: 5px; font-size: 13px;
    selection-background-color: #007bff; selection-color: white;
}
QHeaderView::section {
    background-color: #f8f9fa; padding: 8px; border: none;
    border-bottom: 1px solid #d0d0d0; font-weight: bold;
}
QListWidget {
    background-color: #ffffff; border: 1px solid #d0d0d0;
    border-radius: 5px; font-size: 14px;
}
QListWidget::item { padding: 10px; }
QListWidget::item:selected { background-color: #007bff; color: white; }
QListWidget::item:disabled { color: #999; background-color: #f9f9f9; }
QStatusBar { color: #333; font-weight: bold; }
QPushButton[class="theme_button"] {
    background-color: #e0e0e0;
    color: #333;
    font-size: 16px; font-weight: bold;
    padding: 0px; margin-top: 0px;
    min-width: 30px; max-width: 30px;
    min-height: 30px; max-height: 30px;
    border-radius: 15px; /* Ø¯Ø§Ø¦Ø±ÙŠ */
}
QPushButton[class="theme_button"]:hover { background-color: #d0d0d0; }
QPushButton[class="logout_button"] {
    background-color: #c82333;
    font-size: 12px;
    padding: 5px 10px;
    min-width: 80px;
    max-height: 25px;
}
QRadioButton::indicator {
    width: 16px;
    height: 16px;
    border-radius: 9px; 
    border: 2px solid #999;
    background-color: #f0f0f0;
}
QRadioButton::indicator:hover {
    border: 2px solid #007bff; 
}
QRadioButton::indicator:checked {
    border: 2px solid #007bff; 
    background-color: qradialgradient(
        cx:0.5, cy:0.5, radius: 0.5, fx:0.5, fy:0.5, 
        stop:0.4 #007bff, 
        stop:0.5 #f0f0f0  
    );
}
QRadioButton::indicator:disabled {
    border: 2px solid #ccc;
    background-color: #f9f9f9;
}
QTabWidget::pane { border: 1px solid #d0d0d0; border-radius: 5px; background: white; }
QTabBar::tab { background: #e0e0e0; padding: 10px 20px; border-top-left-radius: 5px; border-top-right-radius: 5px; margin-right: 2px; }
QTabBar::tab:selected { background: #007bff; color: white; }
"""

DARK_MODE_QSS = """
QDialog, QWidget { background-color: #2b2b2b; font-family: "Arial", sans-serif; color: #f0f0f0; }
QFrame[class="card"], QWidget[class="card"] { background-color: #3c3c3c; border-radius: 10px; }
QLabel { font-size: 14px; font-weight: bold; color: #f0f0f0; }
QLabel#TitleLabel { font-size: 24px; font-weight: bold; color: #aaccff; }
QLineEdit, QComboBox {
    font-size: 14px; padding: 10px 15px; border: 1px solid #555;
    border-radius: 5px; background-color: #444; color: #f0f0f0;
}
QLineEdit:focus, QComboBox:focus { border: 1px solid #007bff; }
QPushButton {
    font-size: 14px; font-weight: bold; color: white;
    padding: 12px; border-radius: 5px; border: none; margin-top: 5px;
    background-color: #007bff;
}
QPushButton:hover { background-color: #0056b3; }
QPushButton[class="secondary"] { background-color: #6c757d; }
QPushButton[class="secondary"]:hover { background-color: #5a6268; }
QPushButton[class="danger"] { background-color: #dc3545; }
QPushButton[class="danger"]:hover { background-color: #c82333; }
QPushButton[class="success"] { background-color: #28a745; }
QPushButton[class="success"]:hover { background-color: #218838; }
QTableWidget {
    background-color: #3c3c3c; border: 1px solid #555;
    border-radius: 5px; font-size: 13px;
    selection-background-color: #007bff; selection-color: white;
}
QHeaderView::section {
    background-color: #444; padding: 8px; border: none;
    border-bottom: 1px solid #555; font-weight: bold; color: #f0f0f0;
}
QListWidget {
    background-color: #3c3c3c; border: 1px solid #555;
    border-radius: 5px; font-size: 14px;
}
QListWidget::item { padding: 10px; }
QListWidget::item:selected { background-color: #007bff; color: white; }
QListWidget::item:disabled { color: #777; background-color: #333; }
QStatusBar { color: #f0f0f0; font-weight: bold; }
QPushButton[class="theme_button"] {
    background-color: #555;
    color: #f0f0f0;
    font-size: 16px; font-weight: bold;
    padding: 0px; margin-top: 0px;
    min-width: 30px; max-width: 30px;
    min-height: 30px; max-height: 30px;
    border-radius: 15px; /* Ø¯Ø§Ø¦Ø±ÙŠ */
}
QPushButton[class="theme_button"]:hover { background-color: #666; }
QPushButton[class="logout_button"] {
    background-color: #c82333;
    font-size: 12px;
    padding: 5px 10px;
    min-width: 80px;
    max-height: 25px;
}
QRadioButton::indicator {
    width: 16px;
    height: 16px;
    border-radius: 9px; 
    border: 2px solid #777;
    background-color: #444;
}
QRadioButton::indicator:hover {
    border: 2px solid #007bff; 
}
QRadioButton::indicator:checked {
    border: 2px solid #007bff; 
    background-color: qradialgradient(
        cx:0.5, cy:0.5, radius: 0.5, fx:0.5, fy:0.5, 
        stop:0.4 #007bff, 
        stop:0.5 #444 
    );
}
QRadioButton::indicator:disabled {
    border: 2px solid #555;
    background-color: #333;
}
QTabWidget::pane { border: 1px solid #555; border-radius: 5px; background: #3c3c3c; }
QTabBar::tab { background: #444; padding: 10px 20px; border-top-left-radius: 5px; border-top-right-radius: 5px; margin-right: 2px; color: #f0f0f0; }
QTabBar::tab:selected { background: #007bff; color: white; }
"""

# --- (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…) ---
USER_DB = {
    # Ø­Ø³Ø§Ø¨ Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    'admin': {
        'password': 'admin', 
        'name': 'Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…', 
        'role': 'hod', # Ø¯ÙˆØ± Ø¬Ø¯ÙŠØ¯: Head of Department
        'email': 'hod@university.edu',
        'mobile': '0000000000'
    }
}

# --- (Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯) ---
MOCK_COURSES = {
    'CS101': {
        'name': 'Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©', 'credit_hours': 3,
        'prerequisites': [],
        'sections': [
            {'id': 'CS101_1', 'start': 9, 'end': 10, 'instructor': 'Ø¯. Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', 'hall': '101-Ø¨', 'max_capacity': 50, 'current_enrollment': 45},
            {'id': 'CS101_2', 'start': 11, 'end': 12, 'instructor': 'Ø¯. Ø®Ø§Ù„Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ', 'hall': '102-Ø¨', 'max_capacity': 50, 'current_enrollment': 50},
        ]
    },
    'MATH201': {
        'name': 'Ù…Ø§Ø¯Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'credit_hours': 3,
        'prerequisites': [],
        'sections': [
            {'id': 'MATH201_1', 'start': 9, 'end': 10, 'instructor': 'Ø£. ÙÙ‡Ø¯', 'hall': '201-Ø¬', 'max_capacity': 40, 'current_enrollment': 30},
            {'id': 'MATH201_2', 'start': 10, 'end': 11, 'instructor': 'Ø£. Ø±Ø§Ù…ÙŠ', 'hall': '202-Ø¬', 'max_capacity': 40, 'current_enrollment': 38},
        ]
    },
    'CIRC210': {
        'name': 'Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', 'credit_hours': 3,
        'prerequisites': ['MATH201'],
        'sections': [
            {'id': 'CIRC210_1', 'start': 10, 'end': 11, 'instructor': 'Ø¯. Ø¹Ù…Ø± Ø®Ø§Ù„Ø¯', 'hall': '301-Ø£', 'max_capacity': 30, 'current_enrollment': 25},
            {'id': 'CIRC210_2', 'start': 11, 'end': 12, 'instructor': 'Ø¯. Ù…Ø±ÙˆØ§Ù†', 'hall': '302-Ø£', 'max_capacity': 30, 'current_enrollment': 29},
        ]
    },
    'ENGR101': {
        'name': 'Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ', 'credit_hours': 2,
        'prerequisites': [],
        'sections': [
            {'id': 'ENGR101_1', 'start': 8, 'end': 10, 'instructor': 'Ø¯. Ø±Ø§Ù…ÙŠ', 'hall': 'ÙˆØ±Ø´Ø© 1', 'max_capacity': 20, 'current_enrollment': 15},
            {'id': 'ENGR101_2', 'start': 10, 'end': 12, 'instructor': 'Ø¯. Ù‡Ø§Ù†ÙŠ', 'hall': 'ÙˆØ±Ø´Ø© 2', 'max_capacity': 20, 'current_enrollment': 18},
        ]
    },
    'MATH301': {
        'name': 'ÙƒÙˆÙ…Ø¨Ù„ÙƒØ³', 'credit_hours': 3,
        'prerequisites': ['MATH201'],
        'sections': [
            {'id': 'MATH301_1', 'start': 9, 'end': 10, 'instructor': 'Ø¯. Ø¨Ø±Ù‡Ø§Ù†', 'hall': '401-Ø£', 'max_capacity': 40, 'current_enrollment': 40},
            {'id': 'MATH301_2', 'start': 11, 'end': 12, 'instructor': 'Ø¯. Ø¹Ø§Ø·Ù', 'hall': '402-Ø£', 'max_capacity': 40, 'current_enrollment': 35},
        ]
    },
    'COMM310': {
        'name': 'Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª', 'credit_hours': 3,
        'prerequisites': ['CIRC210'],
        'sections': [
            {'id': 'COMM310_1', 'start': 13, 'end': 14, 'instructor': 'Ø¯. Ø³Ø§Ù…ÙŠ', 'hall': '501-Ø£', 'max_capacity': 30, 'current_enrollment': 10},
        ]
    }
}

PROGRAM_PLANS = {
    'Computer': {
        'Level 1': ['CS101', 'MATH201', 'ENGR101'],
        'Level 2': ['CIRC210', 'MATH301']
    },
    'Communications': {
        'Level 1': ['CS101', 'MATH201', 'ENGR101'],
        'Level 2': ['CIRC210', 'COMM310']
    },
    'Power': {
        'Level 1': ['CS101', 'MATH201', 'ENGR101'],
        'Level 2': ['CIRC210', 'MATH301']
    },
    'Biomedical': {
        'Level 1': ['CS101', 'MATH201'],
        'Level 2': ['CIRC210', 'MATH301']
    }
}

CREDIT_LIMITS = {'min': 12, 'max': 18}

# --- (Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©) ---
def apply_shadow(widget):
    shadow = QGraphicsDropShadowEffect()
    shadow.setBlurRadius(25)
    shadow.setColor(QColor(0, 0, 0, 80))
    shadow.setOffset(0, 5)
    widget.setGraphicsEffect(shadow)
    
def get_section_data(section_id_to_find):
    for course_code, course_info in MOCK_COURSES.items():
        for section in course_info['sections']:
            if section['id'] == section_id_to_find:
                section_data = section.copy()
                section_data['course_name'] = course_info['name']
                section_data['course_code'] = course_code
                section_data['credit_hours'] = course_info['credit_hours']
                section_data['prerequisites'] = course_info['prerequisites']
                return section_data
    return None

def calculate_passed_hours(transcript_list):
    total_hours = 0
    for course_code in transcript_list:
        if course_code in MOCK_COURSES:
            total_hours += MOCK_COURSES[course_code]['credit_hours']
    return total_hours

# --- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
class RegisterWindow(QDialog):
    def __init__(self, role='student', parent=None):
        super().__init__(parent)
        self.role = role
        self.setWindowTitle(f'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ {self.role} Ø¬Ø¯ÙŠØ¯')
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.setModal(True) 
        self.setGeometry(0, 0, 600, 500) 

        card_widget = QWidget()
        card_widget.setProperty("class", "card")
        card_widget.setFixedWidth(400)
        card_widget.setFixedHeight(450) 
        apply_shadow(card_widget)
        
        card_layout = QVBoxLayout(card_widget)
        card_layout.setContentsMargins(30, 30, 30, 30)
        card_layout.setSpacing(15)
        
        title = QLabel(f'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ {self.role} Ø¬Ø¯ÙŠØ¯')
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        title.setObjectName("TitleLabel")
        card_layout.addWidget(title)
        
        form_layout = QFormLayout()
        self.name_input = QLineEdit()
        self.email_input = QLineEdit()
        self.mobile_input = QLineEdit()
        
        form_layout.addRow('Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:', self.name_input)
        form_layout.addRow('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:', self.email_input)
        form_layout.addRow('Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:', self.mobile_input)
        
        if self.role == 'student':
            self.program_combo = QComboBox()
            self.program_combo.addItems(PROGRAM_PLANS.keys())
            form_layout.addRow('Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:', self.program_combo)
            
            self.level_combo = QComboBox()
            self.level_combo.addItems(['Level 1', 'Level 2']) 
            form_layout.addRow('Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:', self.level_combo)
        
        card_layout.addLayout(form_layout)
        card_layout.addStretch()

        self.register_button = QPushButton('Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨')
        self.register_button.clicked.connect(self.create_account)
        card_layout.addWidget(self.register_button)

        main_layout = QHBoxLayout(self)
        main_layout.addStretch()
        main_layout.addWidget(card_widget)
        main_layout.addStretch()

    def create_account(self):
        name = self.name_input.text()
        email = self.email_input.text()
        mobile = self.mobile_input.text()
        if not name or not email or not mobile:
            QMessageBox.warning(self, 'Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„')
            return
            
        new_password = "pass123"
        
        if self.role == 'student':
            program = self.program_combo.currentText()
            level = self.level_combo.currentText()
            if level == 'Level 2':
                mock_transcript = PROGRAM_PLANS[program]['Level 1']
            else:
                mock_transcript = [] 
            
            while True:
                new_academic_id = str(random.randint(100000, 999999))
                if new_academic_id not in USER_DB: break
            
            USER_DB[new_academic_id] = {
                'password': new_password, 'name': name, 'email': email,
                'mobile': mobile, 'role': 'student',
                'program': program, 'level': level, 'transcript': mock_transcript, 'schedule': [] 
            }
            passed_hours = calculate_passed_hours(mock_transcript)
            msg = (f"Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ: {new_academic_id}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: {new_password}\n"
                   f"Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {program} - {level}\n"
                   f"(ØªÙ… ØªØ³Ø¬ÙŠÙ„ {passed_hours} Ø³Ø§Ø¹Ø© Ù…Ø¬ØªØ§Ø²Ø© Ù„Ùƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ùƒ)")
        else:
            first_name = name.split()[0].lower()
            new_academic_id = f"dr_{first_name}{len(USER_DB) + 1}"
            USER_DB[new_academic_id] = {
                'password': new_password, 'name': name, 'email': email,
                'mobile': mobile, 'role': 'doctor'
            }
            msg = (f"Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙƒØªÙˆØ±: {new_academic_id}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: {new_password}")
            
        QMessageBox.information(self, 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', msg)
        self.accept()

# --- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
class LoginWindow(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù†Ø¸Ø§Ù… ODUS')
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.setGeometry(0, 0, 800, 600) 
        self.current_user_id = None
        self.current_user_role = None
        self.is_dark_mode = False 

        window_layout = QVBoxLayout(self)
        
        top_bar_layout = QHBoxLayout()
        top_bar_layout.setContentsMargins(10, 10, 10, 0)
        self.theme_button = QPushButton("ğŸŒ™")
        self.theme_button.setProperty("class", "theme_button")
        self.theme_button.clicked.connect(self.toggle_theme)
        top_bar_layout.addWidget(self.theme_button)
        top_bar_layout.addStretch()
        window_layout.addLayout(top_bar_layout)

        main_layout = QHBoxLayout()
        login_frame = QWidget()
        login_frame.setProperty("class", "card") 
        login_frame.setFixedWidth(450)
        login_frame.setFixedHeight(500)
        apply_shadow(login_frame) 

        card_layout = QVBoxLayout(login_frame)
        card_layout.setContentsMargins(40, 40, 40, 40)
        card_layout.setSpacing(20) 
        title_label = QLabel("Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ")
        title_label.setObjectName("TitleLabel")
        title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        card_layout.addWidget(title_label)
        card_layout.addSpacing(20)
        form_layout = QFormLayout()
        form_layout.setSpacing(15)
        form_layout.setLabelAlignment(Qt.AlignmentFlag.AlignRight)
        self.id_input = QLineEdit()
        self.id_input.setPlaceholderText('Ø§Ù„Ù…Ø¹Ø±Ù (Ù…Ø«Ø§Ù„: 123456)')
        self.pass_input = QLineEdit()
        self.pass_input.setEchoMode(QLineEdit.EchoMode.Password) 
        self.pass_input.setPlaceholderText('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±')
        form_layout.addRow(QLabel("Ø§Ù„Ù…Ø¹Ø±Ù:"), self.id_input)
        form_layout.addRow(QLabel("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:"), self.pass_input)
        card_layout.addLayout(form_layout)
        card_layout.addStretch(1) 
        self.login_button = QPushButton('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„')
        self.register_student_button = QPushButton('Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯')
        self.register_student_button.setProperty("class", "secondary") 
        self.register_doctor_button = QPushButton('Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¯ÙƒØªÙˆØ± Ø¬Ø¯ÙŠØ¯')
        self.register_doctor_button.setProperty("class", "secondary") 
        card_layout.addWidget(self.login_button)
        card_layout.addWidget(self.register_student_button)
        card_layout.addWidget(self.register_doctor_button)
        
        main_layout.addStretch()
        main_layout.addWidget(login_frame)
        main_layout.addStretch()
        
        window_layout.addLayout(main_layout)
        window_layout.addStretch() 

        self.login_button.clicked.connect(self.handle_login)
        self.register_student_button.clicked.connect(self.handle_register_student)
        self.register_doctor_button.clicked.connect(self.handle_register_doctor)

    def toggle_theme(self):
        app = QApplication.instance()
        self.is_dark_mode = not self.is_dark_mode
        if self.is_dark_mode:
            app.setStyleSheet(DARK_MODE_QSS)
            self.theme_button.setText("â˜€ï¸")
        else:
            app.setStyleSheet(LIGHT_MODE_QSS)
            self.theme_button.setText("ğŸŒ™")

    def handle_login(self):
        academic_id = self.id_input.text()
        password = self.pass_input.text()
        if academic_id in USER_DB and USER_DB[academic_id]['password'] == password:
            self.current_user_id = academic_id
            self.current_user_role = USER_DB[academic_id]['role']
            self.accept()
        else:
            QMessageBox.warning(self, 'Ø®Ø·Ø£', 'Ø§Ù„Ù…Ø¹Ø±Ù Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©')
            
    def handle_register_student(self):
        register_dialog = RegisterWindow(role='student', parent=self)
        register_dialog.exec()
        
    def handle_register_doctor(self):
        register_dialog = RegisterWindow(role='doctor', parent=self)
        register_dialog.exec()

# --- Ù†ÙˆØ§ÙØ° Ù…Ø³Ø§Ø¹Ø¯Ø© ---
class ScheduleWindow(QDialog):
    def __init__(self, user_id, parent=None):
        super().__init__(parent)
        self.user_id = user_id
        student_name = USER_DB[self.user_id]["name"]
        self.setWindowTitle(f'Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨: {student_name}')
        self.setWindowFlags(self.windowFlags() | Qt.WindowType.WindowMinMaxButtonsHint)
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.setGeometry(150, 150, 800, 300)
        self.setModal(True) 
        layout = QVBoxLayout(self)
        self.table = QTableWidget()
        layout.addWidget(self.table)
        self.setup_table()
        
    def setup_table(self):
        registered_schedule = USER_DB[self.user_id].get('schedule', [])
        registered_section_ids = [item['id'] for item in registered_schedule]
        
        self.table.setColumnCount(6) 
        self.table.setHorizontalHeaderLabels(['Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„ÙˆÙ‚Øª', 'Ø§Ù„Ù…Ø¯Ø±Ø³', 'Ø§Ù„Ù‚Ø§Ø¹Ø©', 'Ø§Ù„Ø³Ø§Ø¹Ø§Øª'])
        self.table.setRowCount(len(registered_section_ids))
        total_hours = 0
        for row, section_id in enumerate(registered_section_ids):
            data = get_section_data(section_id)
            if data:
                hours = data['credit_hours']
                total_hours += hours
                self.table.setItem(row, 0, QTableWidgetItem(data['course_code']))
                self.table.setItem(row, 1, QTableWidgetItem(data['course_name']))
                self.table.setItem(row, 2, QTableWidgetItem(f"{data['start']}:00 - {data['end']}:00"))
                self.table.setItem(row, 3, QTableWidgetItem(data['instructor']))
                self.table.setItem(row, 4, QTableWidgetItem(data['hall']))
                self.table.setItem(row, 5, QTableWidgetItem(str(hours)))
        self.table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.table.setRowCount(len(registered_section_ids) + 1)
        total_label = QTableWidgetItem(f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: {total_hours}")
        total_label.setFont(QFont("Arial", 10, QFont.Weight.Bold))
        self.table.setItem(len(registered_section_ids), 4, total_label)

class TranscriptWindow(QDialog):
    def __init__(self, user_id, parent=None):
        super().__init__(parent)
        self.user_id = user_id
        student_name = USER_DB[self.user_id]["name"]
        self.setWindowTitle(f'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨: {student_name}')
        self.setWindowFlags(self.windowFlags() | Qt.WindowType.WindowMinMaxButtonsHint)
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.setGeometry(150, 150, 600, 400)
        self.setModal(True)
        layout = QVBoxLayout(self)
        self.table = QTableWidget()
        layout.addWidget(self.table)
        self.setup_table()

    def setup_table(self):
        transcript = USER_DB[self.user_id].get('transcript', [])
        self.table.setColumnCount(3)
        self.table.setHorizontalHeaderLabels(['Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©'])
        self.table.setRowCount(len(transcript))
        total_hours = 0
        for row, course_code in enumerate(transcript):
            course_data = MOCK_COURSES.get(course_code)
            if course_data:
                hours = course_data['credit_hours']
                total_hours += hours
                self.table.setItem(row, 0, QTableWidgetItem(course_code))
                self.table.setItem(row, 1, QTableWidgetItem(course_data['name']))
                self.table.setItem(row, 2, QTableWidgetItem(str(hours)))
        
        self.table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.table.setRowCount(len(transcript) + 1)
        total_label = QTableWidgetItem(f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¬ØªØ§Ø²Ø©: {total_hours}")
        total_label.setFont(QFont("Arial", 10, QFont.Weight.Bold))
        self.table.setItem(len(transcript), 2, total_label)

# --- (Ø¬Ø¯ÙŠØ¯: ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©) ---
class HODDashboard(QWidget):
    def __init__(self, user_id):
        super().__init__()
        self.user_id = user_id
        self.setWindowTitle(f'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… - {USER_DB[self.user_id]["name"]}')
        self.setWindowFlags(Qt.WindowType.Window)
        self.setGeometry(50, 50, 1200, 750)
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.is_dark_mode = False
        self.logout_requested = False
        
        self.init_ui()

    def init_ui(self):
        main_layout = QVBoxLayout(self)
        
        # Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
        top_bar = QHBoxLayout()
        self.theme_button = QPushButton("ğŸŒ™")
        self.theme_button.setProperty("class", "theme_button")
        self.theme_button.clicked.connect(self.toggle_theme)
        top_bar.addWidget(self.theme_button)
        
        self.logout_button = QPushButton("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬")
        self.logout_button.setProperty("class", "logout_button")
        self.logout_button.clicked.connect(self.handle_logout)
        top_bar.addWidget(self.logout_button)
        top_bar.addStretch()
        main_layout.addLayout(top_bar)
        
        # Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        self.tabs = QTabWidget()
        
        # Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù Ù…ÙˆØ§Ø¯)
        self.course_mgmt_tab = QWidget()
        self.init_course_mgmt_tab()
        self.tabs.addTab(self.course_mgmt_tab, "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ù„Ø®Ø·Ø·)")
        
        # Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 2: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù Ø´Ø¹Ø¨)
        self.schedule_mgmt_tab = QWidget()
        self.init_schedule_mgmt_tab()
        self.tabs.addTab(self.schedule_mgmt_tab, "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø´Ø¹Ø¨")
        
        main_layout.addWidget(self.tabs)

    # --- Ù…ÙƒÙˆÙ†Ø§Øª ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ---
    def init_course_mgmt_tab(self):
        layout = QHBoxLayout(self.course_mgmt_tab)
        
        # ÙŠÙ…ÙŠÙ†: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        list_frame = QFrame()
        list_frame.setProperty("class", "card")
        apply_shadow(list_frame)
        list_layout = QVBoxLayout(list_frame)
        list_layout.addWidget(QLabel("Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…"))
        self.courses_list_widget = QListWidget()
        self.refresh_courses_list()
        list_layout.addWidget(self.courses_list_widget)
        self.del_course_btn = QPushButton("Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
        self.del_course_btn.setProperty("class", "danger")
        self.del_course_btn.clicked.connect(self.delete_course)
        list_layout.addWidget(self.del_course_btn)
        
        # ÙŠØ³Ø§Ø±: Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
        form_frame = QFrame()
        form_frame.setProperty("class", "card")
        apply_shadow(form_frame)
        form_layout = QVBoxLayout(form_frame)
        form_layout.addWidget(QLabel("Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©"))
        
        self.new_course_form = QFormLayout()
        self.nc_code = QLineEdit()
        self.nc_name = QLineEdit()
        self.nc_credits = QLineEdit()
        self.nc_prereqs = QLineEdit()
        self.nc_prereqs.setPlaceholderText("Ù…Ø«Ø§Ù„: CS101,MATH201 (Ù…ÙØµÙˆÙ„ Ø¨ÙØ§ØµÙ„Ø©)")
        
        self.new_course_form.addRow("Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø© (ID):", self.nc_code)
        self.new_course_form.addRow("Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:", self.nc_name)
        self.new_course_form.addRow("Ø§Ù„Ø³Ø§Ø¹Ø§Øª:", self.nc_credits)
        self.new_course_form.addRow("Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:", self.nc_prereqs)
        
        form_layout.addLayout(self.new_course_form)
        self.add_course_btn = QPushButton("Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©")
        self.add_course_btn.setProperty("class", "success")
        self.add_course_btn.clicked.connect(self.add_course)
        form_layout.addWidget(self.add_course_btn)
        form_layout.addStretch()
        
        layout.addWidget(list_frame, 1)
        layout.addWidget(form_frame, 1)

    # --- Ù…ÙƒÙˆÙ†Ø§Øª ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
    def init_schedule_mgmt_tab(self):
        layout = QHBoxLayout(self.schedule_mgmt_tab)
        
        # ÙŠÙ…ÙŠÙ†: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø¨
        left_frame = QFrame()
        left_frame.setProperty("class", "card")
        apply_shadow(left_frame)
        l_layout = QVBoxLayout(left_frame)
        l_layout.addWidget(QLabel("1. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø´Ø¹Ø¨Ù‡Ø§"))
        self.sched_course_combo = QComboBox()
        self.sched_course_combo.currentIndexChanged.connect(self.load_sections_for_mgmt)
        l_layout.addWidget(self.sched_course_combo)
        
        self.sections_table = QTableWidget()
        self.sections_table.setColumnCount(7)
        self.sections_table.setHorizontalHeaderLabels(['ID', 'Ø§Ù„Ù…Ø¯Ø±Ø³', 'Ø§Ù„Ø¨Ø¯Ø¡', 'Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', 'Ø§Ù„Ù‚Ø§Ø¹Ø©', 'Ø§Ù„Ø³Ø¹Ø©', 'Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†'])
        self.sections_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.sections_table.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.sections_table.itemSelectionChanged.connect(self.load_section_to_edit)
        l_layout.addWidget(self.sections_table)
        
        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø´Ø¹Ø¨
        btns_layout = QHBoxLayout()
        self.btn_del_section = QPushButton("Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
        self.btn_del_section.setProperty("class", "danger")
        self.btn_del_section.clicked.connect(self.delete_section)
        btns_layout.addWidget(self.btn_del_section)
        l_layout.addLayout(btns_layout)

        # ÙŠØ³Ø§Ø±: Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        right_frame = QFrame()
        right_frame.setProperty("class", "card")
        apply_shadow(right_frame)
        r_layout = QVBoxLayout(right_frame)
        r_layout.addWidget(QLabel("2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¹Ø¨Ø© (Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)"))
        
        self.sec_form = QFormLayout()
        self.sec_id_input = QLineEdit() # Ù„Ù„Ø´Ø¹Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
        self.sec_id_input.setPlaceholderText("Ù…Ø«Ø§Ù„: CS101_3 (ÙØ§Ø±Øº Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)")
        self.sec_inst_input = QLineEdit()
        self.sec_start_input = QLineEdit()
        self.sec_end_input = QLineEdit()
        self.sec_hall_input = QLineEdit()
        self.sec_cap_input = QLineEdit()
        
        self.sec_form.addRow("ID Ø§Ù„Ø´Ø¹Ø¨Ø© (Ù„Ù„Ø¬Ø¯ÙŠØ¯):", self.sec_id_input)
        self.sec_form.addRow("Ø§Ù„Ù…Ø¯Ø±Ø³:", self.sec_inst_input)
        self.sec_form.addRow("ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡:", self.sec_start_input)
        self.sec_form.addRow("ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:", self.sec_end_input)
        self.sec_form.addRow("Ø§Ù„Ù‚Ø§Ø¹Ø©:", self.sec_hall_input)
        self.sec_form.addRow("Ø§Ù„Ø³Ø¹Ø©:", self.sec_cap_input)
        
        r_layout.addLayout(self.sec_form)
        
        self.btn_update_section = QPushButton("Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (Ù„Ù„Ù…Ø­Ø¯Ø¯)")
        self.btn_update_section.clicked.connect(self.update_section)
        r_layout.addWidget(self.btn_update_section)
        
        self.btn_add_section = QPushButton("Ø¥Ø¶Ø§ÙØ© ÙƒØ´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©")
        self.btn_add_section.setProperty("class", "success")
        self.btn_add_section.clicked.connect(self.add_new_section)
        r_layout.addWidget(self.btn_add_section)
        
        r_layout.addStretch()
        
        layout.addWidget(left_frame, 2)
        layout.addWidget(right_frame, 1)
        
        # ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒÙˆÙ…Ø¨Ùˆ Ø¨ÙˆÙƒØ³
        self.refresh_schedule_combo()

    # --- ÙˆØ¸Ø§Ø¦Ù ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ---
    def refresh_courses_list(self):
        self.courses_list_widget.clear()
        for code, data in MOCK_COURSES.items():
            self.courses_list_widget.addItem(f"{code}: {data['name']} ({data['credit_hours']} Ø³Ø§Ø¹Ø§Øª)")

    def add_course(self):
        code = self.nc_code.text().upper().strip()
        name = self.nc_name.text().strip()
        credits_str = self.nc_credits.text().strip()
        prereqs_str = self.nc_prereqs.text().strip()
        
        if not code or not name or not credits_str:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©")
            return
        
        if code in MOCK_COURSES:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
            return
            
        try:
            credits_int = int(credits_str)
            prereqs_list = [p.strip() for p in prereqs_str.split(',')] if prereqs_str else []
            
            MOCK_COURSES[code] = {
                'name': name,
                'credit_hours': credits_int,
                'prerequisites': prereqs_list,
                'sections': [] # Ù‚Ø§Ø¦Ù…Ø© Ø´Ø¹Ø¨ ÙØ§Ø±ØºØ©
            }
            QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø© {code} Ø¨Ù†Ø¬Ø§Ø­")
            self.refresh_courses_list()
            self.refresh_schedule_combo()
            
            # Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
            self.nc_code.clear()
            self.nc_name.clear()
            self.nc_credits.clear()
            self.nc_prereqs.clear()
            
        except ValueError:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹")

    def delete_course(self):
        item = self.courses_list_widget.currentItem()
        if not item: return
        code = item.text().split(':')[0]
        
        reply = QMessageBox.question(self, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", f"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø© {code} ÙˆØ¬Ù…ÙŠØ¹ Ø´Ø¹Ø¨Ù‡Ø§ØŸ",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        if reply == QMessageBox.StandardButton.Yes:
            del MOCK_COURSES[code]
            self.refresh_courses_list()
            self.refresh_schedule_combo()
            QMessageBox.information(self, "ØªÙ…", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©")

    # --- ÙˆØ¸Ø§Ø¦Ù ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
    def refresh_schedule_combo(self):
        self.sched_course_combo.clear()
        self.sched_course_combo.addItem("--- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© ---", None)
        for code, data in MOCK_COURSES.items():
            self.sched_course_combo.addItem(f"{code}: {data['name']}", code)

    def load_sections_for_mgmt(self):
        self.sections_table.setRowCount(0)
        course_code = self.sched_course_combo.currentData()
        if not course_code: return
        
        sections = MOCK_COURSES[course_code]['sections']
        self.sections_table.setRowCount(len(sections))
        for row, sec in enumerate(sections):
            self.sections_table.setItem(row, 0, QTableWidgetItem(sec['id']))
            self.sections_table.setItem(row, 1, QTableWidgetItem(sec['instructor']))
            self.sections_table.setItem(row, 2, QTableWidgetItem(str(sec['start'])))
            self.sections_table.setItem(row, 3, QTableWidgetItem(str(sec['end'])))
            self.sections_table.setItem(row, 4, QTableWidgetItem(sec['hall']))
            self.sections_table.setItem(row, 5, QTableWidgetItem(str(sec['max_capacity'])))
            self.sections_table.setItem(row, 6, QTableWidgetItem(str(sec['current_enrollment'])))

    def load_section_to_edit(self):
        row = self.sections_table.currentRow()
        if row == -1: return
        self.sec_id_input.clear() # Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ID Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ Ù†ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº
        self.sec_inst_input.setText(self.sections_table.item(row, 1).text())
        self.sec_start_input.setText(self.sections_table.item(row, 2).text())
        self.sec_end_input.setText(self.sections_table.item(row, 3).text())
        self.sec_hall_input.setText(self.sections_table.item(row, 4).text())
        self.sec_cap_input.setText(self.sections_table.item(row, 5).text())

    def update_section(self):
        course_code = self.sched_course_combo.currentData()
        row = self.sections_table.currentRow()
        if not course_code or row == -1:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„")
            return
        
        try:
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ MOCK_COURSES
            sec_ref = MOCK_COURSES[course_code]['sections'][row]
            sec_ref['instructor'] = self.sec_inst_input.text()
            sec_ref['start'] = int(self.sec_start_input.text())
            sec_ref['end'] = int(self.sec_end_input.text())
            sec_ref['hall'] = self.sec_hall_input.text()
            sec_ref['max_capacity'] = int(self.sec_cap_input.text())
            
            QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¹Ø¨Ø©")
            self.load_sections_for_mgmt()
        except ValueError:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…")

    def add_new_section(self):
        course_code = self.sched_course_combo.currentData()
        if not course_code:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹")
            return
            
        sid = self.sec_id_input.text().strip()
        if not sid:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ID Ù„Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©")
            return
            
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± ID
        for sec in MOCK_COURSES[course_code]['sections']:
            if sec['id'] == sid:
                QMessageBox.warning(self, "Ø®Ø·Ø£", "Ù‡Ø°Ø§ ID Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")
                return

        try:
            new_sec = {
                'id': sid,
                'instructor': self.sec_inst_input.text(),
                'start': int(self.sec_start_input.text()),
                'end': int(self.sec_end_input.text()),
                'hall': self.sec_hall_input.text(),
                'max_capacity': int(self.sec_cap_input.text()),
                'current_enrollment': 0
            }
            MOCK_COURSES[course_code]['sections'].append(new_sec)
            QMessageBox.information(self, "Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©")
            self.load_sections_for_mgmt()
        except ValueError:
            QMessageBox.warning(self, "Ø®Ø·Ø£", "ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…")

    def delete_section(self):
        course_code = self.sched_course_combo.currentData()
        row = self.sections_table.currentRow()
        if not course_code or row == -1: return
        
        sid = self.sections_table.item(row, 0).text()
        reply = QMessageBox.question(self, "Ø­Ø°Ù", f"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø¨Ø© {sid}ØŸ",
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        if reply == QMessageBox.StandardButton.Yes:
            del MOCK_COURSES[course_code]['sections'][row]
            self.load_sections_for_mgmt()

    def handle_logout(self):
        reply = QMessageBox.question(self, 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬', 
                                     'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No, 
                                     QMessageBox.StandardButton.No)
        if reply == QMessageBox.StandardButton.Yes:
            self.logout_requested = True
            self.close() 

    def toggle_theme(self):
        app = QApplication.instance()
        self.is_dark_mode = not self.is_dark_mode
        if self.is_dark_mode:
            app.setStyleSheet(DARK_MODE_QSS)
            self.theme_button.setText("â˜€ï¸")
        else:
            app.setStyleSheet(LIGHT_MODE_QSS)
            self.theme_button.setText("ğŸŒ™")

# --- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
class RegistrationApp(QWidget):
    def __init__(self, user_id):
        super().__init__()
        self.user_id = user_id 
        self.setWindowTitle(f'Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ù…Ø±Ø­Ø¨Ø§Ù‹ {USER_DB[self.user_id]["name"]}')
        self.setWindowFlags(Qt.WindowType.Window)
        self.setGeometry(100, 100, 1200, 700) 
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.registered_sections_data = [] 
        self.is_dark_mode = False 
        
        self.logout_requested = False
        
        self.section_button_group = QButtonGroup()
        
        self.init_ui()
        self.load_schedule_and_courses()

    def init_ui(self):
        window_layout = QVBoxLayout(self) 
        window_layout.setContentsMargins(15, 15, 15, 15)
        
        top_bar_layout = QHBoxLayout()
        top_bar_layout.setContentsMargins(0, 0, 0, 10) 
        
        self.theme_button = QPushButton("ğŸŒ™")
        self.theme_button.setProperty("class", "theme_button")
        self.theme_button.clicked.connect(self.toggle_theme)
        top_bar_layout.addWidget(self.theme_button)
        
        self.logout_button = QPushButton("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬")
        self.logout_button.setProperty("class", "logout_button")
        self.logout_button.setCursor(Qt.CursorShape.PointingHandCursor)
        self.logout_button.clicked.connect(self.handle_logout)
        top_bar_layout.addWidget(self.logout_button)
        
        top_bar_layout.addStretch()
        window_layout.addLayout(top_bar_layout)
        
        main_layout = QHBoxLayout() 
        main_layout.setSpacing(15)
        window_layout.addLayout(main_layout) 

        # --- 1. Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰: Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© ---
        available_frame = QFrame()
        available_frame.setProperty("class", "card")
        apply_shadow(available_frame)
        available_layout = QVBoxLayout(available_frame)
        
        user_data = USER_DB[self.user_id]
        info_label = QLabel(f"Ø§Ù„Ø·Ø§Ù„Ø¨: {user_data['name']}\nØ§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {user_data['program']} - {user_data['level']}")
        info_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        available_layout.addWidget(info_label)
        available_layout.addWidget(QLabel('Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù…Ù† Ù‡Ù†Ø§'))
        
        self.available_courses_list = QListWidget()
        self.available_courses_list.currentItemChanged.connect(self.display_sections)
        available_layout.addWidget(self.available_courses_list)

        # --- 2. Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ³Ø·Ù‰: Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ---
        sections_frame = QFrame()
        sections_frame.setProperty("class", "card")
        apply_shadow(sections_frame)
        sections_layout = QVBoxLayout(sections_frame)
        
        self.sections_label = QLabel('Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©')
        
        sections_layout.addWidget(self.sections_label)
        self.available_sections_table = QTableWidget()
        
        self.available_sections_table.setColumnCount(7) 
        self.available_sections_table.setHorizontalHeaderLabels(['Ø§Ø®ØªÙŠØ§Ø±', 'Ø§Ù„Ù…Ø¯Ø±Ø³', 'Ø§Ù„ÙˆÙ‚Øª', 'Ø§Ù„Ù‚Ø§Ø¹Ø©', 'Ø§Ù„Ø³Ø¹Ø©', 'Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†', 'ID'])
        self.available_sections_table.setColumnHidden(6, True) 
        
        self.available_sections_table.setSelectionMode(QTableWidget.SelectionMode.NoSelection)
        
        self.available_sections_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.available_sections_table.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeMode.ResizeToContents) 

        sections_layout.addWidget(self.available_sections_table)
        self.add_button = QPushButton('Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© <--')
        self.add_button.clicked.connect(self.add_section)
        sections_layout.addWidget(self.add_button)

        # --- 3. Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙŠØ³Ø±Ù‰: Ø¬Ø¯ÙˆÙ„ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ ---
        registered_frame = QFrame()
        registered_frame.setProperty("class", "card")
        apply_shadow(registered_frame)
        registered_layout = QVBoxLayout(registered_frame)
        registered_layout.addWidget(QLabel('Ø¬Ø¯ÙˆÙ„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©)'))
        self.registered_schedule_table = QTableWidget()
        self.registered_schedule_table.setColumnCount(6)
        self.registered_schedule_table.setHorizontalHeaderLabels(['Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„Ù…Ø¯Ø±Ø³', 'Ø§Ù„ÙˆÙ‚Øª', 'Ø§Ù„Ù‚Ø§Ø¹Ø©', 'Ø§Ù„Ø³Ø§Ø¹Ø§Øª', 'ID'])
        self.registered_schedule_table.setColumnHidden(5, True)
        self.registered_schedule_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        self.registered_schedule_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.registered_schedule_table.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        
        registered_layout.addWidget(self.registered_schedule_table)
        
        hours_layout = QHBoxLayout()
        hours_font = QFont("Arial", 10, QFont.Weight.Bold)
        self.passed_hours_label = QLabel("Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¬ØªØ§Ø²Ø©: 0")
        self.passed_hours_label.setFont(hours_font)
        self.registered_hours_label = QLabel("Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: 0")
        self.registered_hours_label.setFont(hours_font)
        self.registered_hours_label.setStyleSheet("color: blue;")
        self.total_hours_label = QLabel("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0")
        self.total_hours_label.setFont(hours_font)
        self.total_hours_label.setStyleSheet("color: green;")
        hours_layout.addWidget(self.passed_hours_label)
        hours_layout.addWidget(self.registered_hours_label)
        hours_layout.addWidget(self.total_hours_label)
        registered_layout.addLayout(hours_layout)
        
        buttons_layout = QHBoxLayout()
        self.remove_button = QPushButton('--> Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©')
        self.remove_button.setProperty("class", "danger") 
        self.remove_button.clicked.connect(self.remove_section)
        
        self.show_transcript_button = QPushButton('Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ')
        self.show_transcript_button.setProperty("class", "secondary") 
        self.show_transcript_button.clicked.connect(self.open_transcript_window)
        
        self.show_schedule_button = QPushButton('Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ (Ø·Ø¨Ø§Ø¹Ø©)')
        self.show_schedule_button.setProperty("class", "secondary") 
        self.show_schedule_button.clicked.connect(self.open_schedule_window)
        
        buttons_layout.addWidget(self.remove_button)
        buttons_layout.addWidget(self.show_transcript_button) 
        registered_layout.addLayout(buttons_layout)
        registered_layout.addWidget(self.show_schedule_button) 
        
        self.status_bar = QStatusBar()
        self.status_bar.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        registered_layout.addWidget(self.status_bar)
        
        main_layout.addWidget(available_frame, 1) 
        main_layout.addWidget(sections_frame, 2)  
        main_layout.addWidget(registered_frame, 2) 

    def handle_logout(self):
        reply = QMessageBox.question(self, 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬', 
                                     'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No, 
                                     QMessageBox.StandardButton.No)
        if reply == QMessageBox.StandardButton.Yes:
            self.logout_requested = True
            self.close() 

    def toggle_theme(self):
        app = QApplication.instance()
        self.is_dark_mode = not self.is_dark_mode
        if self.is_dark_mode:
            app.setStyleSheet(DARK_MODE_QSS)
            self.theme_button.setText("â˜€ï¸")
        else:
            app.setStyleSheet(LIGHT_MODE_QSS)
            self.theme_button.setText("ğŸŒ™")

    def calculate_registered_hours(self):
        total_hours = 0
        for section_data in self.registered_sections_data:
            total_hours += section_data['credit_hours']
        return total_hours

    def calculate_passed_hours_from_db(self):
        transcript_list = USER_DB[self.user_id].get('transcript', [])
        return calculate_passed_hours(transcript_list)

    def load_schedule_and_courses(self):
        self.available_courses_list.clear()
        self.available_sections_table.setRowCount(0)
        self.registered_schedule_table.setRowCount(0)
        self.registered_sections_data.clear()
        self.sections_label.setText('Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„')
        
        registered_schedule = USER_DB[self.user_id].get('schedule', [])
        registered_section_ids = [item['id'] for item in registered_schedule]
        
        registered_course_codes = set()
        current_registered_hours = 0
        
        passed_hours = self.calculate_passed_hours_from_db()
        
        self.registered_schedule_table.setRowCount(len(registered_section_ids))
        for row, section_id in enumerate(registered_section_ids):
            data = get_section_data(section_id)
            if data:
                self.registered_sections_data.append(data)
                
                registered_course_codes.add(data['course_code'])
                hours = data['credit_hours']
                current_registered_hours += hours
                self.registered_schedule_table.setItem(row, 0, QTableWidgetItem(data['course_name']))
                self.registered_schedule_table.setItem(row, 1, QTableWidgetItem(data['instructor']))
                self.registered_schedule_table.setItem(row, 2, QTableWidgetItem(f"{data['start']}:00 - {data['end']}:00"))
                self.registered_schedule_table.setItem(row, 3, QTableWidgetItem(data['hall']))
                self.registered_schedule_table.setItem(row, 4, QTableWidgetItem(str(hours)))
                self.registered_schedule_table.setItem(row, 5, QTableWidgetItem(section_id)) 
        
        for course_code, course_info in MOCK_COURSES.items():
            hours = course_info['credit_hours']
            display_text = f"{course_code}: {course_info['name']} ({hours} Ø³Ø§Ø¹Ø§Øª)"
            item = QListWidgetItem(display_text)
            item.setData(Qt.ItemDataRole.UserRole, course_code)
            
            if course_code in registered_course_codes:
                item.setFlags(item.flags() & ~Qt.ItemFlag.ItemIsEnabled)
                item.setForeground(Qt.GlobalColor.gray)
                
            self.available_courses_list.addItem(item)
            
        self.passed_hours_label.setText(f"Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¬ØªØ§Ø²Ø©: {passed_hours}")
        self.registered_hours_label.setText(f"Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: {current_registered_hours}")
        self.total_hours_label.setText(f"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {passed_hours + current_registered_hours}")
        
    @pyqtSlot(QListWidgetItem)
    def display_sections(self, current_item):
        self.section_button_group = QButtonGroup()
        
        if not current_item or not (current_item.flags() & Qt.ItemFlag.ItemIsEnabled):
            self.available_sections_table.setRowCount(0)
            self.sections_label.setText('Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„')
            return
            
        course_id = current_item.data(Qt.ItemDataRole.UserRole)
        course_info = MOCK_COURSES[course_id]
        sections = course_info['sections']
        self.sections_label.setText(f"Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© Ù„Ù€ ({course_info['name']} - {course_info['credit_hours']} Ø³Ø§Ø¹Ø§Øª)")
        
        self.available_sections_table.setRowCount(len(sections))
        for row, section in enumerate(sections):
            
            radio_button = QRadioButton()
            radio_button.setProperty("section_id", section['id'])
            
            cell_widget = QWidget()
            cell_layout = QHBoxLayout(cell_widget)
            cell_layout.addWidget(radio_button)
            cell_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
            cell_layout.setContentsMargins(0, 0, 0, 0)
            
            self.available_sections_table.setCellWidget(row, 0, cell_widget)
            self.section_button_group.addButton(radio_button)
            
            self.available_sections_table.setItem(row, 1, QTableWidgetItem(section['instructor']))
            self.available_sections_table.setItem(row, 2, QTableWidgetItem(f"{section['start']}:00 - {section['end']}:00"))
            self.available_sections_table.setItem(row, 3, QTableWidgetItem(section['hall']))
            
            self.available_sections_table.setItem(row, 4, QTableWidgetItem(str(section['max_capacity'])))
            enrollment_item = QTableWidgetItem(str(section['current_enrollment']))
            
            if section['current_enrollment'] >= section['max_capacity']:
                enrollment_item.setForeground(QColor('red'))
                enrollment_item.setFont(QFont("Arial", 9, QFont.Weight.Bold))
                radio_button.setEnabled(False) 
                
            self.available_sections_table.setItem(row, 5, enrollment_item)
            self.available_sections_table.setItem(row, 6, QTableWidgetItem(section['id']))
            
    def add_section(self):
        
        checked_button = self.section_button_group.checkedButton()
        
        if not checked_button:
            QMessageBox.warning(self, 'Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆØ³Ø· Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©')
            return
            
        chosen_section_id = checked_button.property("section_id")
        
        new_section_data = get_section_data(chosen_section_id)
        if not new_section_data: return

        user_data = USER_DB[self.user_id]
        user_transcript = user_data['transcript']
        user_program_plans = PROGRAM_PLANS[user_data['program']][user_data['level']]
        current_registered_hours = self.calculate_registered_hours()
        
        course_code = new_section_data['course_code']
        course_name = new_section_data['course_name']
        course_credits = new_section_data['credit_hours']

        # 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©
        prereqs = new_section_data['prerequisites']
        missing_prereqs = []
        for prereq_code in prereqs:
            if prereq_code not in user_transcript:
                missing_prereqs.append(prereq_code)
                
        if missing_prereqs:
            QMessageBox.critical(self, 'Ø®Ø·Ø£: Ù…ØªØ·Ù„Ø¨ Ù…Ø³Ø¨Ù‚ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„',
                f"Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ '{course_name}'.\n"
                f"Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ©: {', '.join(missing_prereqs)}")
            return

        # 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø®Ø·Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        if course_code not in user_program_plans:
            reply = QMessageBox.warning(self, 'ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…Ø§Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø·Ø©',
                f"Ø§Ù„Ù…Ø§Ø¯Ø© '{course_name}' Ù„ÙŠØ³Øª Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø®Ø·ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.\n"
                "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ (Ù‚Ø¯ Ù„Ø§ ØªÙØ­ØªØ³Ø¨)ØŸ",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.No)
            if reply == QMessageBox.StandardButton.No:
                return

        # 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¹Ø© Ø§Ù„Ø´Ø¹Ø¨Ø© 
        if new_section_data['current_enrollment'] >= new_section_data['max_capacity']:
            QMessageBox.critical(self, 'Ø®Ø·Ø£: Ø§Ù„Ø´Ø¹Ø¨Ø© Ù…Ù…ØªÙ„Ø¦Ø©',
                f"Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø´Ø¹Ø¨Ø© '{course_name}' (Ø§Ù„Ù…Ø¯Ø±Ø³: {new_section_data['instructor']}).\n"
                "Ø§Ù„Ø´Ø¹Ø¨Ø© Ù…Ù…ØªÙ„Ø¦Ø©.")
            return

        # 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø§Ø¹Ø§Øª
        if (current_registered_hours + course_credits) > CREDIT_LIMITS['max']:
            QMessageBox.critical(self, 'Ø®Ø·Ø£: ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø§Ø¹Ø§Øª',
                f"Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© '{course_name}' ({course_credits} Ø³Ø§Ø¹Ø§Øª).\n"
                f"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ù‡Ùˆ {CREDIT_LIMITS['max']} Ø³Ø§Ø¹Ø©ØŒ ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø³ØªØ¬Ø¹Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§ØªÙƒ {current_registered_hours + course_credits} Ø³Ø§Ø¹Ø©.")
            return

        # 6. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø§Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª
        new_start = new_section_data['start']
        new_end = new_section_data['end']
        for reg_section in self.registered_sections_data:
            reg_start = reg_section['start']
            reg_end = reg_section['end']
            if (new_start < reg_end) and (new_end > reg_start):
                QMessageBox.critical(self, 'Ø®Ø·Ø£: ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„',
                    f"Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ©: '{new_section_data['course_name']}'\n"
                    f"ØªØªØ¹Ø§Ø±Ø¶ Ù…Ø¹: '{reg_section['course_name']}' (Ø´Ø¹Ø¨Ø© {reg_section['instructor']})")
                return 

        # 7. Ø¥Ø°Ø§ Ù†Ø¬Ø­ ÙƒÙ„ Ø´ÙŠØ¡
        from datetime import datetime
        current_time_str = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        USER_DB[self.user_id]['schedule'].append({
            'id': chosen_section_id,
            'registration_time': current_time_str
        })
        
        for section in MOCK_COURSES[course_code]['sections']:
            if section['id'] == chosen_section_id:
                section['current_enrollment'] += 1
                break
        
        self.load_schedule_and_courses()
        self.status_bar.showMessage(f"âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ©: {new_section_data['course_name']} | ÙÙŠ: {current_time_str}", 4000)

    def remove_section(self):
        selected_row_index = self.registered_schedule_table.currentRow()
        if selected_row_index == -1:
            QMessageBox.warning(self, 'Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø¨Ø© Ù…Ù† (Ø¬Ø¯ÙˆÙ„ÙŠ) Ù„Ø­Ø°ÙÙ‡Ø§')
            return
            
        section_id_to_remove = self.registered_schedule_table.item(selected_row_index, 5).text()
        section_data = get_section_data(section_id_to_remove)
        course_credits = section_data['credit_hours']
        course_code = section_data['course_code']
        current_registered_hours = self.calculate_registered_hours()

        if (current_registered_hours - course_credits) < CREDIT_LIMITS['min']:
            reply = QMessageBox.warning(self, 'ØªØ­Ø°ÙŠØ±: Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰',
                f"Ø­Ø°Ù Ù…Ø§Ø¯Ø© '{section_data['course_name']}' Ø³ÙŠØ¬Ø¹Ù„ Ù…Ø¬Ù…ÙˆØ¹ Ø³Ø§Ø¹Ø§ØªÙƒ {current_registered_hours - course_credits} Ø³Ø§Ø¹Ø©.\n"
                f"ÙˆÙ‡Ø°Ø§ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ({CREDIT_LIMITS['min']} Ø³Ø§Ø¹Ø©).\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.No)
            if reply == QMessageBox.StandardButton.No:
                return

        schedule_list = USER_DB[self.user_id]['schedule']
        item_to_remove = None
        for item in schedule_list:
            if item['id'] == section_id_to_remove:
                item_to_remove = item
                break
        
        if item_to_remove:
            schedule_list.remove(item_to_remove)
            
            for section in MOCK_COURSES[course_code]['sections']:
                if section['id'] == section_id_to_remove:
                    section['current_enrollment'] -= 1
                    break
                    
            self.load_schedule_and_courses()
            self.status_bar.showMessage(f"ØªÙ… Ø­Ø°Ù: {section_data['course_name']} Ø¨Ù†Ø¬Ø§Ø­", 3000)
            
    def open_schedule_window(self):
        schedule_dialog = ScheduleWindow(self.user_id, self)
        schedule_dialog.exec()

    def open_transcript_window(self):
        transcript_dialog = TranscriptWindow(self.user_id, self)
        transcript_dialog.exec()

# --- Ù†Ø§ÙØ°Ø© Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¯ÙƒØªÙˆØ± (Ø£Ø¨Ø³Ø· Ù…Ù† Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…) ---
class DoctorDashboard(QWidget):
    def __init__(self, user_id):
        super().__init__()
        self.user_id = user_id
        self.setWindowTitle(f'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†Ø³Ù‚ - Ø¯. {USER_DB[self.user_id]["name"]}')
        self.setWindowFlags(Qt.WindowType.Window)
        self.setGeometry(100, 100, 1000, 600)
        self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
        self.current_course_id = None
        self.current_section_index = -1
        self.is_dark_mode = False 
        self.logout_requested = False
        self.init_ui()

    def init_ui(self):
        window_layout = QVBoxLayout(self)
        window_layout.setContentsMargins(15, 15, 15, 15)
        
        top_bar_layout = QHBoxLayout()
        top_bar_layout.setContentsMargins(0, 0, 0, 10)
        self.theme_button = QPushButton("ğŸŒ™")
        self.theme_button.setProperty("class", "theme_button")
        self.theme_button.clicked.connect(self.toggle_theme)
        top_bar_layout.addWidget(self.theme_button)
        
        self.logout_button = QPushButton("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬")
        self.logout_button.setProperty("class", "logout_button")
        self.logout_button.setCursor(Qt.CursorShape.PointingHandCursor)
        self.logout_button.clicked.connect(self.handle_logout)
        top_bar_layout.addWidget(self.logout_button)

        top_bar_layout.addStretch()
        window_layout.addLayout(top_bar_layout)

        main_layout = QHBoxLayout() 
        main_layout.setSpacing(15)
        window_layout.addLayout(main_layout)
        
        left_frame = QFrame()
        left_frame.setProperty("class", "card")
        apply_shadow(left_frame)
        left_layout = QVBoxLayout(left_frame)
        left_layout.addWidget(QLabel('Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„'))
        self.course_combo = QComboBox()
        self.course_combo.addItem("--- Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© ---", None)
        for course_id, info in MOCK_COURSES.items():
            self.course_combo.addItem(f"{course_id}: {info['name']}", course_id)
        self.course_combo.currentIndexChanged.connect(self.load_sections)
        left_layout.addWidget(self.course_combo)
        left_layout.addWidget(QLabel('Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„'))
        self.sections_table = QTableWidget()
        
        self.sections_table.setColumnCount(7)
        self.sections_table.setHorizontalHeaderLabels(['ID', 'Ø§Ù„Ù…Ø¯Ø±Ø³', 'Ø§Ù„Ø¨Ø¯Ø¡', 'Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', 'Ø§Ù„Ù‚Ø§Ø¹Ø©', 'Ø§Ù„Ø³Ø¹Ø©', 'Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†'])
        
        self.sections_table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
        self.sections_table.setSelectionMode(QTableWidget.SelectionMode.SingleSelection)
        self.sections_table.itemSelectionChanged.connect(self.load_section_details)
        left_layout.addWidget(self.sections_table)

        right_frame = QFrame()
        right_frame.setProperty("class", "card")
        apply_shadow(right_frame)
        right_layout = QVBoxLayout(right_frame)
        right_layout.addWidget(QLabel('Ø§Ù„Ø®Ø·ÙˆØ© 3: Ù‚Ù… Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø«Ù… Ø§Ø­ÙØ¸'))
        self.edit_form = QFormLayout()
        self.instructor_input = QLineEdit()
        self.start_time_input = QLineEdit()
        self.end_time_input = QLineEdit()
        self.hall_input = QLineEdit()
        self.capacity_input = QLineEdit()
        
        self.edit_form.addRow('Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³:', self.instructor_input)
        self.edit_form.addRow('ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ (Ø±Ù‚Ù…):', self.start_time_input)
        self.edit_form.addRow('ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø±Ù‚Ù…):', self.end_time_input)
        self.edit_form.addRow('Ø§Ù„Ù‚Ø§Ø¹Ø©:', self.hall_input)
        self.edit_form.addRow('Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰:', self.capacity_input) 
        
        right_layout.addLayout(self.edit_form)
        self.save_button = QPushButton('Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª')
        self.save_button.clicked.connect(self.save_changes)
        right_layout.addWidget(self.save_button)
        right_layout.addStretch() 

        main_layout.addWidget(left_frame, 2)
        main_layout.addWidget(right_frame, 1)

    def handle_logout(self):
        reply = QMessageBox.question(self, 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬', 
                                     'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No, 
                                     QMessageBox.StandardButton.No)
        if reply == QMessageBox.StandardButton.Yes:
            self.logout_requested = True
            self.close() 

    def toggle_theme(self):
        app = QApplication.instance()
        self.is_dark_mode = not self.is_dark_mode
        if self.is_dark_mode:
            app.setStyleSheet(DARK_MODE_QSS)
            self.theme_button.setText("â˜€ï¸")
        else:
            app.setStyleSheet(LIGHT_MODE_QSS)
            self.theme_button.setText("ğŸŒ™")

    def load_sections(self):
        self.current_course_id = self.course_combo.currentData()
        self.sections_table.setRowCount(0)
        self.clear_form()
        if not self.current_course_id:
            return
            
        sections = MOCK_COURSES[self.current_course_id]['sections']
        self.sections_table.setRowCount(len(sections))
        for row, section in enumerate(sections):
            self.sections_table.setItem(row, 0, QTableWidgetItem(section['id']))
            self.sections_table.setItem(row, 1, QTableWidgetItem(section['instructor']))
            self.sections_table.setItem(row, 2, QTableWidgetItem(str(section['start'])))
            self.sections_table.setItem(row, 3, QTableWidgetItem(str(section['end'])))
            self.sections_table.setItem(row, 4, QTableWidgetItem(section['hall']))
            self.sections_table.setItem(row, 5, QTableWidgetItem(str(section['max_capacity'])))
            self.sections_table.setItem(row, 6, QTableWidgetItem(str(section['current_enrollment'])))
            
    def load_section_details(self):
        selected_row = self.sections_table.currentRow()
        if selected_row == -1 or not self.current_course_id:
            self.clear_form()
            return
            
        self.current_section_index = selected_row
        instructor = self.sections_table.item(selected_row, 1).text()
        start = self.sections_table.item(selected_row, 2).text()
        end = self.sections_table.item(selected_row, 3).text()
        hall = self.sections_table.item(selected_row, 4).text()
        capacity = self.sections_table.item(selected_row, 5).text() 
        
        self.instructor_input.setText(instructor)
        self.start_time_input.setText(start)
        self.end_time_input.setText(end)
        self.hall_input.setText(hall)
        self.capacity_input.setText(capacity) 

    def save_changes(self):
        if self.current_course_id is None or self.current_section_index == -1:
            QMessageBox.warning(self, 'Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© ÙˆØ´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹')
            return
            
        try:
            new_instructor = self.instructor_input.text()
            new_start = int(self.start_time_input.text())
            new_end = int(self.end_time_input.text())
            new_hall = self.hall_input.text()
            new_capacity = int(self.capacity_input.text()) 
            
            if not new_instructor or not new_hall:
                raise ValueError("Ø§Ù„Ø®Ø§Ù†Ø§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ©")
            
            section_ref = MOCK_COURSES[self.current_course_id]['sections'][self.current_section_index]
            section_ref['instructor'] = new_instructor
            section_ref['start'] = new_start
            section_ref['end'] = new_end
            section_ref['hall'] = new_hall
            section_ref['max_capacity'] = new_capacity 
            
            QMessageBox.information(self, 'Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­')
            self.load_sections()
            
        except ValueError as e:
            QMessageBox.critical(self, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„', f'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø© Ù„Ù„Ø£ÙˆÙ‚Ø§Øª ÙˆØ§Ù„Ø³Ø¹Ø©.\n{e}')
        except Exception as e:
            QMessageBox.critical(self, 'Ø®Ø·Ø£', f'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}')

    def clear_form(self):
        self.current_section_index = -1
        self.instructor_input.clear()
        self.start_time_input.clear()
        self.end_time_input.clear()
        self.hall_input.clear()
        self.capacity_input.clear() 

if __name__ == '__main__':
    app = QApplication(sys.argv)
    app.setStyleSheet(LIGHT_MODE_QSS)
    
    while True:
        login_window = LoginWindow()
        result = login_window.exec()

        if result == QDialog.DialogCode.Accepted:
            current_user = login_window.current_user_id 
            current_role = login_window.current_user_role
            is_dark = login_window.is_dark_mode
            
            main_window = None
            
            if current_role == 'student':
                main_window = RegistrationApp(current_user) 
            elif current_role == 'doctor':
                main_window = DoctorDashboard(current_user)
            elif current_role == 'hod': # ÙØªØ­ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…
                main_window = HODDashboard(current_user)
            
            if main_window:
                main_window.is_dark_mode = is_dark
                if is_dark: 
                    app.setStyleSheet(DARK_MODE_QSS)
                    main_window.theme_button.setText("â˜€ï¸")
                else:
                    app.setStyleSheet(LIGHT_MODE_QSS)
                    main_window.theme_button.setText("ğŸŒ™")
                
                main_window.show()
                
                app.exec()
                
                if getattr(main_window, 'logout_requested', False):
                    continue 
                else:
                    break 
            else:
                break
        else:
            break

    sys.exit(0)
